name: Playwright Tests

on:
  push:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
      - name: Determine TARGET_REPO_URL
        name: Playwright Tests

        on:
          push:
            branches: [ master, main ]

        jobs:
          test:
            runs-on: ubuntu-latest
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                  node-version: '18'

              - name: Determine TARGET_REPO_URL
                id: target
                run: |
                  if [ -f .env ]; then
                    url=$(grep -E '^TARGET_REPO_URL=' .env | cut -d'=' -f2- || true)
                    echo "TARGET=$url"
                    echo "TARGET_REPO_URL=$url" >> $GITHUB_ENV
                  fi

              - name: Clone target tests repo
                run: |
                  repo_url=${TARGET_REPO_URL:-https://github.com/tenypeter007/saucedemo-playwright.git}
                  echo "Cloning tests repo: $repo_url"
                  git clone "$repo_url" tests-repo

              - name: Install dependencies for tests
                working-directory: tests-repo
                run: npm install

              - name: Install Playwright system dependencies and browsers for tests
                working-directory: tests-repo
                run: |
                  name: Playwright Tests

                  on:
                    push:
                      branches: [ master, main ]

                  jobs:
                    test:
                      runs-on: ubuntu-latest
                      steps:
                        - name: Checkout
                          uses: actions/checkout@v4

                        - name: Setup Node.js
                          uses: actions/setup-node@v4
                          with:
                            node-version: '18'

                        - name: Determine TARGET_REPO_URL
                          id: target
                          run: |
                            if [ -f .env ]; then
                              url=$(grep -E '^TARGET_REPO_URL=' .env | cut -d'=' -f2- || true)
                              echo "TARGET=$url"
                              echo "TARGET_REPO_URL=$url" >> $GITHUB_ENV
                            fi

                        - name: Clone target tests repo
                          run: |
                            repo_url=${TARGET_REPO_URL:-https://github.com/tenypeter007/saucedemo-playwright.git}
                            echo "Cloning tests repo: $repo_url"
                            git clone "$repo_url" tests-repo

                        - name: Install dependencies for tests
                          working-directory: tests-repo
                          run: npm install

                        - name: Install Playwright system dependencies and browsers for tests
                          working-directory: tests-repo
                          run: |
                            npx playwright install-deps || true
                            npx playwright install

                        - name: Run Playwright tests (HTML report) â€” only new/changed tests in last commit
                          working-directory: tests-repo
                          run: |
                            changed_files=$(git show --name-only --pretty="" HEAD | tr '\n' ' ')
                            echo "Changed files in last commit: $changed_files"

                            test_files=$(git show --name-only --pretty="" HEAD | grep -E '\.(spec|test)\.(ts|js|mjs|cjs|jsx|tsx)$' || true)
                            gen_files=$(git show --name-only --pretty="" HEAD | grep '^tests/generated/' || true)

                            if [ -n "$test_files" ] || [ -n "$gen_files" ]; then
                              echo "Running only changed/generated tests"
                              targets=""
                              for f in $test_files $gen_files; do
                                targets="$targets $f"
                              done
                              echo "Executing: npx playwright test $targets --reporter=html"
                              npx playwright test $targets --reporter=html
                            else
                              echo "No new test files detected in last commit."
                              if [ -d tests/generated ] && [ "$(ls -A tests/generated)" ]; then
                                echo "Falling back to tests/generated"
                                npx playwright test tests/generated --reporter=html
                              else
                                echo "Falling back to all tests"
                                npx playwright test --reporter=html
                              fi
                            fi

                        - name: Upload Playwright HTML report
                          uses: actions/upload-artifact@v4
                          with:
                            name: playwright-report
                            path: tests-repo/playwright-report
